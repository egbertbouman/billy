var app=angular.module("billy",["ui.bootstrap","ngCookies"]);app.factory("jPlayerFactory",["$rootScope",function(t){var e={};return e.create=function(e,i){this.player=$(e).jPlayer({supplied:"mp3",wmode:"window",cssSelectorAncestor:i,ready:function(){t.$broadcast("ready")},play:function(){t.$broadcast("playing")},ended:function(){t.$broadcast("ended")},pause:function(){t.$broadcast("paused")},loadstart:function(){t.$broadcast("loadstart")},error:function(){t.$broadcast("error")}})},e.load_and_play=function(t){this.clear(),this.player.jPlayer("setMedia",{mp3:t.link}),this.player.jPlayer("play"),this.track=t},e.play=function(){this.player.jPlayer("play")},e.pause=function(){this.player.jPlayer("pause")},e.stop=function(){this.player.jPlayer("stop")},e.clear=function(){this.player.jPlayer("clearMedia"),this.track=void 0},e.set_volume=function(t){this.player.jPlayer("volume",t/100)},e.seek=function(t){this.player.jPlayer("play",t)},e.get_current_time=function(t){return this.player.data("jPlayer").status.currentTime},e.get_duration=function(t){return this.player.data("jPlayer").status.duration},e}]),app.factory("YoutubePlayerFactory",["$rootScope",function(t){var e={};return e.create=function(e){var i=this;$.getScript("http://www.youtube.com/iframe_api"),$('<div id="'+e+'"></div>').appendTo("body"),window.onYouTubeIframeAPIReady=function(){i.player=new YT.Player(e,{height:"200",width:"320",playerVars:{autohide:1,autoplay:0,controls:0,fs:1,disablekb:0,modestbranding:1,iv_load_policy:3,rel:0,showinfo:0,theme:"dark",color:"red"},events:{onReady:function(e){t.$broadcast("ready",e)},onStateChange:function(e){switch(e.data){case-1:t.$broadcast("loadstart");break;case 0:t.$broadcast("ended");break;case 1:t.$broadcast("playing");break;case 2:t.$broadcast("paused");break;case 5:t.$broadcast("loadstart")}},onError:function(e){t.$broadcast("error",e)}}})}},e.load_and_play=function(t){this.clear(),this.player.cueVideoById(t.link.substring(8)),this.player.playVideo(),this.track=t},e.play=function(){this.player.playVideo()},e.pause=function(){this.player.pauseVideo()},e.stop=function(){this.player.stopVideo(),t.$broadcast("paused")},e.clear=function(){this.stop(),this.player.clearVideo(),this.track=void 0},e.set_volume=function(t){this.player.setVolume(t)},e.seek=function(t){this.player.seekTo(t)},e.get_current_time=function(t){return-1===this.player.getPlayerState()?0:this.player.getCurrentTime()},e.get_duration=function(t){return this.player.getDuration()},e}]),app.factory("SoundCloudPlayerFactory",["$rootScope",function(t){var e={};return e.create=function(e){var i=this;$.when($.getScript("http://connect.soundcloud.com/sdk.js"),$.getScript("https://w.soundcloud.com/player/api.js"),$.Deferred(function(t){$(t.resolve)})).done(function(){SC.initialize({client_id:"ac0c94880338e855de3743d143368221"}),$('<iframe id="'+e+'" src="https://w.soundcloud.com/player/?url=https://api.soundcloud.com/tracks/39804767&show_artwork=false&liking=false&sharing=false&auto_play=false" scrolling="no" frameborder="no"></iframe>').appendTo("body"),i.player=SC.Widget(e),i.player.bind(SC.Widget.Events.READY,function(){i.players_ready+=1,i.players_ready===i.players_total&&t.$broadcast("ready")}),i.player.bind(SC.Widget.Events.PLAY,function(){t.$broadcast("playing")}),i.player.bind(SC.Widget.Events.PAUSE,function(){t.$broadcast("paused")}),i.player.bind(SC.Widget.Events.FINISH,function(){t.$broadcast("ended")}),i.player.bind(SC.Widget.Events.PLAY_PROGRESS,function(){i.player.getPosition(function(e){0===e&&t.$broadcast("loadstart"),i.player_position=e/1e3}),i.player.getDuration(function(t){i.player_duration=t/1e3})}),i.player.bind(SC.Widget.Events.ERROR,function(){t.$broadcast("error")})})},e.load_and_play=function(t){this.clear();var e=this;this.player.load("http://api.soundcloud.com/tracks/"+t.link.substring(11),{callback:function(){e.player.play()}}),this.track=t},e.play=function(){this.player.play()},e.pause=function(){this.player.pause()},e.stop=function(){this.player.pause(),this.player.seekTo(0)},e.clear=function(){this.track=void 0},e.set_volume=function(t){this.player.setVolume(t/100)},e.seek=function(t){this.player.seekTo(1e3*t)},e.get_current_time=function(t){return this.player_position},e.get_duration=function(t){return this.player_duration},e}]),app.service("MusicService",["$rootScope","jPlayerFactory","YoutubePlayerFactory","SoundCloudPlayerFactory",function(t,e,i,a){e.create("#player-core","#player-ui"),i.create("yt_player"),a.create("sc_player"),this.playing=!1,this.players={jplayer:e,youtube:i,soundcloud:a},this.playlists={},this.name=void 0,this.index=0,this.get_player_type=function(){var t=this.track&&this.track.link||"";return 0===t.indexOf("youtube:")?"youtube":0===t.indexOf("soundcloud:")?"soundcloud":"jplayer"},this.get_player=function(){return this.players[this.get_player_type()]},this.load_and_play=function(t){this.track&&this.stop(),void 0!==t.index&&t.name?(this.track=this.playlists[t.name].tracks[t.index],this.name=t.name,this.index=t.index):(this.track=t.track,this.name=this.index=void 0),this.get_player().load_and_play(this.track)},this.play=function(){this.get_player().play()},this.pause=function(){this.get_player().pause()},this.stop=function(){this.get_player().stop()},this.seek=function(t){this.get_player().seek(t)},this.get_current_time=function(){return this.get_player().get_current_time()},this.get_duration=function(){return this.get_player().get_duration()},this.set_volume=function(t){Object.keys(this.players).forEach(function(e){this.players[e].set_volume(t)},this),this.volume=t},this.set_playlists=function(t){this.playlists=t},this.get_playlists=function(){return this.playlists},this.add_playlist=function(t,e){this.playlists[t]=e},this.delete_playlist=function(t){return Object.keys(this.playlists).length>1?(delete this.playlists[t],!0):!1},this.reposition=function(t,e,i){var a=this.playlists[t].tracks,n=a[e];a.splice(e,1),a.splice(e-i,0,n),this.index<e&&this.index+i<e&&(this.index+=i),this.index<e&&this.index+i>e&&(this.index-=i)},this.next=function(){var t=this.index+1<this.playlists[this.name].tracks.length?this.index+1:0;t>0&&(this.load_and_play({name:this.name,index:t}),this.index=t)},this.previous=function(){var t=this.index-1>=0?this.index-1:this.playlists[this.name].tracks.length-1;t<this.playlists[this.name].tracks.length-1&&(this.load_and_play({name:this.name,index:t}),this.index=t)},this.add=function(t,e){this.playlists[t].tracks.push(e)},this.remove=function(t,e){this.playlists[t].tracks.splice(e,1)};var n=this;t.$on("playing",function(t){n.playing=!0}),t.$on("paused",function(t){n.playing=!1}),t.$on("ended",function(t){n.playing=!1})}]),app.service("ApiService",["$http","$cookies","HelperService",function(t,e,i){this.api_base="http://musesync.ewi.tudelft.nl:8000/api",this.api_session=this.api_base+"/session",this.api_playlists=this.api_base+"/playlists?token={0}&search={1}",this.api_tracks=this.api_base+"/tracks?query={0}&id={1}&offset={2}",this.api_recommend=this.api_base+"/recommend?token={0}&name={1}&offset={2}",this.api_clicklog=this.api_base+"/clicklog?token={0}",this.api_waveform=this.api_base+"/waveform?id={0}",this.api_info=this.api_base+"/info",this.init=function(){var t=location.port||("https:"===location.protocol?"443":"80");this.cookie_name="token"+t,this.token=i.getParameterByName("token")||e.get(this.cookie_name),this.token&&(this.token=this.token.replace(/\/+$/g,""))},this.do_get=function(e,i){return t.get(e).then(function(t){return t.data},i?null:this.show_and_throw_error)},this.do_post=function(e,i,a){return t.post(e,i).then(function(t){return t.data},a?null:this.show_and_throw_error)},this.show_and_throw_error=function(t){var e=t.data&&t.data.error?"Got error from server ("+t.data.error+")":"Failed to contact Billy server";throw i.alert(e),t},this.new_session=function(t){var i=this;return this.do_get(this.api_session,t).then(function(t){i.token=t.token;var a=new Date;return a.setYear(a.getYear()+10),e.put(i.cookie_name,i.token),t})},this.get_playlists=function(t){return this.do_get(i.formatString(this.api_playlists,this.token,""),t)},this.post_playlists=function(t,e){return this.do_post(i.formatString(this.api_playlists,this.token,""),JSON.stringify(t),e)},this.get_tracks=function(t,e,a){return this.do_get(i.formatString(this.api_tracks,t,"",e),a)},this.get_recommendation=function(t,e,a){return this.do_get(i.formatString(this.api_recommend,this.token,t,e),a)},this.post_clicklog=function(t,e){return this.do_post(i.formatString(this.api_clicklog,this.token,""),t,e)},this.get_waveform=function(t,e){return this.do_get(i.formatString(this.api_waveform,t,""),e)},this.get_info=function(t){return this.do_get(this.api_info,t)},this.init()}]),app.service("HelperService",["$uibModal",function(t){this.padNumber=function(t,e){for(var i=String(t);i.length<(e||2);)i="0"+i;return i},this.formatTime=function(t){return t>=60?this.padNumber(Math.floor(t/60),2)+":"+this.padNumber(Math.round(t%60),2):"00:"+this.padNumber(Math.round(t),2)},this.getParameterByName=function(t){t=t.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var e=new RegExp("[\\?&]"+t+"=([^&#]*)"),i=e.exec(location.search);return null===i?"":decodeURIComponent(i[1].replace(/\+/g," "))},this.replaceParameter=function(t,e,i){var a=new RegExp("\\b("+e+"=).*?(&|$)");return t.search(a)>=0?t.replace(a,"$1"+i+"$2"):t+(t.indexOf("?")>0?"&":"?")+e+"="+i},this.formatString=function(){var t=Array.prototype.slice.call(arguments),e=t.shift();return e.replace(/\{(\d+)\}/g,function(e,i){return t[i]})},this.alert=function(e){t.open({animation:!1,templateUrl:"app/views/alert_modal.html",controller:["$scope",function(t){t.message=e}]})}}]),app.controller("PlaylistCtrl",["$scope","$rootScope","$timeout","$cookies","$uibModal","HelperService","MusicService","ApiService",function(t,e,i,a,n,s,o,r){t.tabs={},t.musicservice=o;var l=function(){r.get_playlists(!0).then(function(e){o.set_playlists(t.playlists=e),$.isEmptyObject(e)&&t.playlist_modal()},function(e){404==e.status&&s.getParameterByName("token")?(document.body.innerHTML="",s.alert("Failed to find Billy session")):r.new_session().then(function(e){o.set_playlists(t.playlists={}),t.playlist_modal()})})},c=function(){var e=jQuery.extend(!0,{},t.playlists);return Object.keys(e).forEach(function(t){var i=e[t],a=[];i.tracks.forEach(function(t){a.push(t._id)}),i.tracks=a}),r.post_playlists(e)};t.export_playlists=function(){var e=new Blob([JSON.stringify(t.playlists)],{type:"application/json;charset=utf-8;"}),i=angular.element("<a></a>");i.attr("href",window.URL.createObjectURL(e)),i.attr("download","playlists.json"),i[0].click()},t.import_playlists=function(){var e=document.getElementById("file").files[0];if(e){var i=new FileReader;i.readAsText(e,"UTF-8"),i.onloadend=function(e){var i=JSON.parse(e.target.result),a=[];for(var n in i)n in t.playlists?a.push(n):t.playlists[n]=i[n];a.length>0&&s.alert("You already have playlist(s) with the following name(s): "+a.join(", ")+". Since playlist names have to be unique, these will not be imported.")},i.onerror=function(t){s.alert("Could not read file!")}}},t.playlist_modal=function(){var t=n.open({animation:!1,templateUrl:"app/views/playlist_modal.html",controller:"PlaylistModalCtrl"});t.result.then(function(t){t.tracks=[],o.add_playlist(t.name,t),c()},function(){})},t.delete_playlist=function(t){o.delete_playlist(t)?c():s.alert("You should have at least one playlist. Please create a new one before deleting this one.")},t.next=function(){o.next()},t.previous=function(){o.previous()},t.move_up=function(t,e){o.reposition(t,e,1),c()},t.move_down=function(t,e){o.reposition(t,e,-1),c()},t.load_and_play=function(t,e){o.load_and_play({name:t,index:e})},t.add=function(t){o.add(u,t),c().then(function(){e.$broadcast("recommend",u)})},t.remove=function(t,i){o.remove(t,i),c().then(function(){e.$broadcast("recommend",t)})};var u;t.$watch("tabs",function(t,i){Object.keys(t).forEach(function(a){(t[a]||{}).active&&!(i[a]||{}).active&&(e.$broadcast("recommend",a),u=a)})},!0),t.$on("loadstart",function(t){$("#yt_player").toggle("youtube"===o.get_player_type()),"soundcloud"===o.get_player_type()&&o.set_volume(o.volume)}),t.$on("ended",function(e){t.next()}),t.$on("add",function(e,i){t.add(i)}),l()}]),app.controller("PlaylistModalCtrl",["$scope","$uibModalInstance",function(t,e){t.functions={foreground:!1,background:!1,action:!1},t.save=function(){if(t.name_popover=!t.name,t.description_popover=!t.description,t.name&&t.description){var i=[];Object.keys(t.functions).forEach(function(e){t.functions[e]&&i.push(e)}),e.close({name:t.name,description:t.description,functions:i,type:t.identity_playlist?"identity":"user"})}},t.close=function(){e.dismiss("cancel")}}]),app.controller("ResultCtrl",["$rootScope","$scope","MusicService","ApiService",function(t,e,i,a){function n(){var t=(e.tabs.search.current_page-1)*e.tabs.search.page_size;a.get_tracks(e.query,t).then(function(t){e.tabs.search.total_items=t.total,e.tabs.search.page_size=t.page_size,angular.copy(t.results,e.tabs.search.results),e.tabs.search.active=!0})}function s(){var t=(e.tabs.recommendation.current_page-1)*e.tabs.recommendation.page_size;a.get_recommendation(e.playlist_name,t).then(function(t){e.tabs.recommendation.total_items=t.total,e.tabs.recommendation.page_size=t.page_size,angular.copy(t.results,e.tabs.recommendation.results)})}e.tabs={search:{active:!1,current_page:1,page_size:0,results:[]},recommendation:{active:!0,current_page:1,page_size:0,results:[]}},e.musicservice=i,e.load_and_play=function(t){i.load_and_play({track:t})},e.add=function(e){t.$broadcast("add",e)},e.page_changed=function(){e.tabs.search.active?n():s()},e.$on("search",function(t,i){e.tabs.search.current_page=1,e.query=i,n()}),e.$on("recommend",function(t,i){e.tabs.recommendation.current_page=1,e.playlist_name=i,s()})}]),app.controller("PlayerCtrl",["$scope","$rootScope","$interval","HelperService","MusicService",function(t,e,i,a,n){t.musicservice=n,t.load_and_play=function(t){n.load_and_play({track:t})},t.play=function(){n.play()},t.pause=function(){n.pause()},t.stop=function(){n.stop()},t.next=function(){n.next()},t.previous=function(){n.previous()},t.timeline_click=function(e){var i=$(e.currentTarget).width(),a=e.offsetX/i;n.seek(a*t.duration)},t.volume_click=function(e){var i=$(e.currentTarget).width(),a=e.offsetX/i*100;n.set_volume(a),t.current_volume=a},t.current_time=0,t.current_volume=80,i(function(){var e=n.get_current_time();t.current_time=e,t.current_time_str=a.formatTime(e),e=n.get_duration(),t.duration=e||1,t.duration_str=a.formatTime(e),t.playing=n.playing},1e3)}]),app.controller("HeaderCtrl",["$rootScope","$scope","HelperService","ApiService",function(t,e,i,a){e.url=i.replaceParameter(window.location.href,"token",a.token),e.search=function(){t.$broadcast("search",e.query)},e.status=function(){a.get_info().then(function(t){e.status=t,e.status.info.total_tracks=0,Object.keys(e.status.info.num_tracks).forEach(function(t,i){e.status.info.total_tracks+=e.status.info.num_tracks[t]})})},e.$watch("status_shown",function(t,i){t&&e.status()})}]),app.directive("clipboardCopy",function(){return{restrict:"A",link:function(t,e,i){e.bind("click",function(t){var e=$("<input>");$("body").append(e),e.val(i.clipboardCopy).select(),document.execCommand("copy"),e.remove()})}}}),app.filter("underscoreless",function(){return function(t){return t.replace(/_/g," ")}}),angular.module("billy").run(["$templateCache",function(t){t.put("app/views/alert_modal.html",'<div class="modal-header" style="border-bottom: none;"><button type="button" class="close" ng-click="$close()">&times;</button><h4 class="modal-title">Alert</h4></div><div class="modal-body">{{ message }}</div><div class="modal-footer" style="border-top: none;"><button class="btn btn-primary" type="button" ng-click="$close()">OK</button></div>'),t.put("app/views/musicinfo_popover.html",'<div class="popover-container"><table ng-init="limit = 6"><tr ng-if="result.musicinfo.similar_artists"><td>Similar artists</td><td><span class="label label-success" ng-repeat="artist in result.musicinfo.similar_artists | limitTo: limit as similar_artists">{{ artist }}</span> <a ng-show="result.musicinfo.similar_artists.length !== similar_artists.length" ng-click="limit = undefined" class="text-nowrap">show more...</a></td></tr><tr ng-show="!result.musicinfo.similar_artists"><td>No data</td></tr></table></div>'),t.put("app/views/playlist_modal.html",'<div class="modal-header"><button type="button" class="close" ng-click="close()">&times;</button><h4 class="modal-title">Create new playlist</h4></div><div class="modal-body"><form><div class="form-group"><label class="control-label">Name</label> <input type="text" class="form-control" placeholder="Please enter a name which does not match any of your existing playlist names." uib-popover="Please fill out this field." popover-is-open="name_popover" popover-trigger="none" ng-model="name"></div><div class="form-group"><label class="control-label">Purpose</label> <textarea class="form-control" rows="3" placeholder="For what purpose would you like to use this playlist? Please enter a short description here." uib-popover="Please fill out this field." popover-is-open="description_popover" popover-trigger="none" ng-model="description"></textarea></div><div class="form-group"><div class="checkbox"><label><input type="checkbox" ng-model="identity_playlist"> This playlist is an identity playlist</label></div></div><div class="form-group"><label class="control-label">How will you use the playlist music?</label><div class="checkbox"><label><input type="checkbox" ng-model="functions.foreground"> Music listening will be my main activity and focus of attention.</label></div><div class="checkbox"><label><input type="checkbox" ng-model="functions.background"> I will use the music in connection to a non-musical activity. I should primarily focus on this activity; the music should support but not distract me.</label></div><div class="checkbox"><label><input type="checkbox" ng-model="functions.action"> I will use the music in connection to a non-musical activity. Focusing on the music will help me to conduct the activity better.</label></div></div></form></div><div class="modal-footer"><button type="button" class="btn btn-default" ng-click="close()">Close</button> <button type="submit" class="btn btn-primary" ng-click="save()">Save</button></div>'),t.put("app/views/status_popover.html",'<div class="popover-container"><table><tr><td>status</td><td></td><td><span ng-repeat="activity in status.info.status" class="label" ng-class="activity==\'idle\' ? \'label-success\' : \'label-danger\'">{{ activity }}</span></td></tr><tr><td>#sources</td><td></td><td>{{ status.info.num_sources }}</td></tr><tr><td>#sessions</td><td></td><td>{{ status.info.num_sessions }}</td></tr><tr><td>#tracks</td><td>total</td><td>{{ status.info.total_tracks }}</td></tr><tr ng-repeat="(source_type, count) in status.info.num_tracks"><td></td><td>{{ source_type }}</td><td>{{ count }}</td></tr><tr><td nowrap>session url</td><td></td><td><div class="input-group input-group-sm"><div class="input-group-btn"><button id="copy-session-id" class="btn btn-default" type="button" clipboard-copy="{{ url }}"><span class="glyphicon glyphicon-copy" style="font-size:100%;"></span></button></div><input id="session-id" type="text" class="form-control" style="background:#fff;width:100px;" value="{{ url }}" readonly></div></td></tr></table></div>')}]);